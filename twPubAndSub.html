<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>TruckWeight Dashboard</title>
  <meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no' />
  <style>
    html, body { margin:0; padding:0; }
    #text { position:absolute; top:5px; }
    #chart { left:0; right:0; display:flex; align-items:center; }
    #gaugeChart, #donutChart, #barChart, #splineChart { flex:1; margin:10px; }
    #map { position:absolute; top:345px; bottom:10px; left:10px; right:10px }
  </style>
  <link type='text/css' rel='stylesheet' href='//pubnub.github.io/eon/v/eon/1.1.0/eon.css'/>
  <script type='text/javascript' src='//pubnub.github.io/eon/v/eon/1.1.0/eon.js'></script>
  <script type='text/javascript' src='//pubnub.github.io/eon/v/eon-map/1.1.4/eon-map.js'></script>
</head>

<body>

<div id='text'><h3>&nbsp; &nbsp; &nbsp; Asset: TW822357-TT</h2></div>
<div id='chart'>
  <div id='gaugeChart'></div>
  <div id='donutChart'></div>
  <div id='barChart'></div>
  <div id='splineChart'></div>
</div>
<div id='map'></div>


<script>


  // create PubNub instance/connection
  var pn = new PubNub({ publishKey:'demo', subscribeKey:'demo' });
  //ssl:(('https:' == document.location.protocol) ? true : false)

  var cChans = ['chan1', 'chan123', 'chan1234'];
  var mChans = ['pubnub-mapbox-1', 'pubnub-mapbox-2', 'pubnub-mapbox-3'];
  var o1 = [44.734,-63.655], o2 = [44.732,-63.657], o3 = [44.738,-63.646];

  ///////////////////////////////////////////////////////////////////////
  // GENERATE & PUBLISH TRUCK DATA

  // WEIGHT & TEMP - generate/publish new data on 3 channels to pubsub.com
  var a1=0, a2=0, a3=0, t1=0
  setInterval(function() {
    a1 = 30+Math.floor(Math.random()*69)
    a2 = 20+Math.floor(Math.random()*9)
    a3 = 75+Math.floor(Math.random()*15)
    t1 = 7+Math.floor(Math.random()*5)
    // send data to 3 channels which will in turn cause updating of the 4 subscribed/listening charts
    pn.publish({channel:cChans[0], message:{eon:{'Axle 1':a1}}})
    pn.publish({channel:cChans[1], message:{eon:{'Axle 1':a1,'Axle 2':a2,'Axle 3':a3}}})
    pn.publish({channel:cChans[2], message:{eon:{'Axle 1':a1,'Axle 2':a2,'Axle 3':a3,'Temp':t1}}})
  }, 3000);

  // LATLON - generate/publish data for 3 trucks on 3 channels to pubsub.com
  function startPublishingPositions() {
    setInterval(function() {
      createAndPublishNewLatlon('t1', mChans[0]);
      createAndPublishNewLatlon('t2', mChans[1]);
      createAndPublishNewLatlon('t3', mChans[2]);
    }, 8000); };
  function createAndPublishNewLatlon(pointId, channel) {
    var latlon = [Math.round((o1[0]+(getNonZeroRandomNumber()*0.00005))*10000)/10000,
      Math.round((o1[1]+(getNonZeroRandomNumber()*0.00010))*10000)/10000];
    var m = {}; m[pointId] = { latlng:latlon, data:pointId };
    //m = {t1: {latlng: [44.7297, -63.6601], data: "t1"}}
    pn.publish({ channel:channel, message:m});}
  function getNonZeroRandomNumber() {
    var random = Math.floor(Math.random()*199)-99;
    if (random==0) return getNonZeroRandomNumber();
    return random;
  }



  ///////////////////////////////////////////////////////////////////////
  // CREATE MAPS/CHARTS/PLOTS & SUBSCRIBE TO APPROPRIATE CHANNELS

  // create map & subscribe to the map channels
  map = eon.map({
    pubnub:pn, id:'map', channels:mChans, //debug:true,
    mbId:'ianjennings.l896mh2e',
    mbToken:'pk.eyJ1IjoiaWFuamVubmluZ3MiLCJhIjoiZExwb0p5WSJ9.XLi48h-NOyJOCJuu1-h-Jg',
    options: { center:o1, attributionControl:false, zoom:12.5, zoomAnimation:false },
    rotate:true, history:false,
    //message: function(data) { map.setView(data[3].latlng, 13); },

    // create custom marker/callout for each truck
    marker: function(latlng, data) {
      //console.log(data);
      if (data == 't1') {
        var iconUrl = 'https://i.imgur.com/8bpGqH1.png', size = [10.5, 26];
        m1.options.icon = L.icon({ iconUrl: iconUrl, iconSize: size });
        m1.options.title = 'truck 1';
        m1.bindPopup('<b>Truck 1 : --kg</b>&nbsp;&nbsp;&nbsp;('+o1+')');
        return m1; }
      else if (data == 't2') {
        var iconUrl = 'https://i.imgur.com/49K1RbM.png'; size = [9.5, 23];
        m2.options.icon = L.icon({ iconUrl: iconUrl, iconSize: size });
        m2.options.title = 'truck 2';
        m2.bindPopup('<b>Truck 2 : --kg</b>&nbsp;&nbsp;&nbsp;('+o2+')');
        return m2; }
      else if (data == 't3') {
        var iconUrl = 'https://i.imgur.com/oRAWrqA.png'; size = [11.5, 35];
        m3.options.icon = L.icon({ iconUrl: iconUrl, iconSize: size });
        m3.options.title = 'truck 3';
        m3.bindPopup('<b>Truck 3 : --kg</b>&nbsp;&nbsp;&nbsp;('+o3+')');
        return m3; } },
    connect:startPublishingPositions,
  });


  // create charts & subscribe to the required weight/temp channel(s) for each chart
  eon.chart({
    pubnub:pn, id:'gaugeChart', channels:[cChans[0]], //debug:true,
    generate: {
      bindto:'#gaugeChart',
      data: { labels:true, type:'gauge' },
      color: { pattern:['#60B044','#F6C600','#FF0000'], threshold: { values:[50,80,100] },},
      gauge: { min:0, max:100, label: { format: function(value, ratio) { return (value)+'kg' }}}}});
  eonChart = eon.chart({
    pubnub:pn, id:'donutChart', channels:[cChans[1]],
    generate: {
      bindto:'#donutChart', tooltip: { show:true },
      data: { labels:true, type:'donut' },
      donut: { title:'Axle Ratios' }, }});
  eon.chart({
    pubnub:pn, id:'barChart', channels:[cChans[2]],
    generate: {
      bindto:'#barChart', tooltip: { show:true },
      data: { labels:true, type:'bar' },
      bar: { zerobased:true, width: { ratio:1 } },
      axis: { y: { max:90 } }, }});
  eon.chart({
    pubnub:pn, id:'splineChart', channels:[cChans[2]], limit:5,
    generate: {
      bindto:'#splineChart', tooltip: { show:false },
      data: { labels:false, type:'area-spline' },
      area: { zerobased:true },
      axis: { x: { type:'timeseries', tick: { format:'%H:%m:%S' } }, y: { max:95 } },
  }});


  ///////////////////////////////////////////////////////////////////////
  // CREATE & MANAGE MAPBOX ITEMS E.G MARKERS & THEIR CALLOUTS

  // create custom map marker that rotates to match direction of travel
  L.RotatedMarker = L.Marker.extend({
    options: { angle: 0 },
    _setPos: function(pos) {
      L.Marker.prototype._setPos.call(this, pos);
      if (L.DomUtil.TRANSFORM) { // use the CSS transform rule if available
        this._icon.style[L.DomUtil.TRANSFORM] += ' rotate('+this.options.angle+'deg)'; }
      else if (L.Browser.ie) { // fallback for IE6, IE7, IE8
        let rad = this.options.angle*L.LatLng.DEG_TO_RAD
        let costheta = Math.cos(rad), sintheta = Math.sin(rad);
        this._icon.style.filter +=
          ' progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\', M11='+
          costheta+', M12='+(-sintheta)+', M21='+sintheta+', M22='+costheta+')';
  }}});

  // create global marker instances so we can access/update them anywhere
  var m1 = new L.RotatedMarker(o1, { riseOnHover:true });
  var m2 = new L.RotatedMarker(o2, { riseOnHover:true });
  var m3 = new L.RotatedMarker(o3, { riseOnHover:true });

  // update marker callouts every second
  var latlon1=0, latlon2=0, latlon3=0, w1=0, w2=0, w3=0;
  setInterval(function() {
    latlon1 = [Math.round(m1.getLatLng().lat*10000)/10000,
      Math.round(m1.getLatLng().lng*10000)/10000];
    latlon2 = [Math.round(m2.getLatLng().lat*10000)/10000,
      Math.round(m2.getLatLng().lng*10000)/10000];
    latlon3 = [Math.round(m3.getLatLng().lat*10000)/10000,
      Math.round(m3.getLatLng().lng*10000)/10000];
    w1 = eonChart.data.values('Axle 1');
    w2 = eonChart.data.values('Axle 2');
    w3 = eonChart.data.values('Axle 3');
    let str = 'kg</b>&nbsp;&nbsp;&nbsp;(';
    m1.bindPopup('<b>Truck 1 : '+w1+str+latlon1+')');
    m2.bindPopup('<b>Truck 2 : '+w2+str+latlon2+')');
    m3.bindPopup('<b>Truck 3 : '+w3+str+latlon3+')');
  }, 1000);


</script>


</body>
</html>

